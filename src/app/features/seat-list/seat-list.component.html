<app-header></app-header>
<div class="container-fluid " style="margin-top: 100px;">
  <mat-stepper #stepper>
    <mat-step  state="seat">
  
      <ng-template matStepLabel>
        <span fxShow="false" fxShow.gt-xs="true">{{"selectSeatInstruction"|translate}}</span>
       </ng-template>
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4" style="margin-bottom: 5px;">
            <div class="trip-detail-title"> {{routeState.operator| uppercase}} Bus {{"tripDetail"|translate}}</div>
              <div class="trip-detail-item">
                <i class="material-icons trip-result-icon">event</i>
                <span class="trip-detail-property">{{"tripDate"|translate}} :</span>
                <span class="trip-detail-value">{{ routeState.tripDate | date:"MMM dd, Y"}}</span>
              </div>
              <div class="trip-detail-item">
                <i class="material-icons trip-result-icon">place</i>
                <span class="trip-detail-property">{{"route"|translate}}</span>:
                <span class="trip-detail-value">{{ routeState.departureLocation |translate}}
                  - {{routeState.arrivalLocation |translate}}</span>
              </div>
              <div class="trip-detail-item">
                <i class="material-icons trip-result-icon">business</i>
                <span class="trip-detail-property">{{"departureStation"|translate}}:</span>:
                <span class="trip-detail-value">{{routeState.departureStation}}</span>
              </div>
              <div class="trip-detail-item">
                <i class="material-icons trip-result-icon">business</i>
                <span class="trip-detail-property">{{"arrivalStation"|translate}}:</span>:
                <span class="trip-detail-value"> {{routeState.arrivalStation}}</span>
              </div>
              <div class="trip-detail-item">
                <i class="material-icons trip-result-icon">
                  watch_later
                </i> <span class="trip-detail-property">{{"departureTime"|translate}}</span>:
                <span class="trip-detail-value"> {{routeState.departureTime|date:"hh:mm"}}</span>
              </div>
              <div class="trip-detail-item">
                <i class="material-icons trip-result-icon">call</i>
                <span class="trip-detail-property">{{"departureSupportPhone"|translate}}</span>:
                <span class="trip-detail-value">{{routeState.departureLocationPhone}}</span>
              </div>
              <div class="trip-detail-item">
                <i class="material-icons trip-result-icon">payments</i>
                <span class="trip-detail-property">{{"price"|translate}}:</span>:
                <span class="trip-detail-value">{{ routeState.price}} ETB</span>
              </div>
          </div>
    

        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4" style="margin-bottom: 5px;">
         
            <div class="trip-detail-title">{{"selectASeat"|translate}}</div>
            <div *ngFor="let seatrow of seatmap">
              <div class="col-12 pricing-label"
                   *ngIf="seatChartConfig?.showRowWisePricing && seatrow.seatPricingInformation != ''">{{seatrow.seatPricingInformation}}</div>
              <div class="seatrow container">
                <div *ngIf="seatChartConfig?.showRowsLabel">
                  <div class="row-label">  {{seatrow.seatRowLabel}} </div>
                </div>
                <div *ngFor="let seatobj of seatrow.seats">
                  <div class="seat-item seat-space" style="color:white ; background-color:white"
                       *ngIf="seatobj.seatLabel == ''"> &nbsp;
                  </div>
                  <div tooltip="Seat : {{seatobj.seatLabel}} | Price : {{seatobj.price}}Rs" placement="top"
                       [ngClass]="{ 'seat-item' : true , 'seat-available' : seatobj.status == 'available' ,'seat-booked' : seatobj.status == 'booked' ,'seat-unavailable' : seatobj.status == 'unavailable' }"
                       (click)="selectSeat(seatobj)"
                       *ngIf="(seatobj.status == 'available' || seatobj.status == 'booked' )&& seatobj.seatLabel != ''">{{seatobj.seatNo}}</div>
                  <div tooltip="Seat not available" placement="top"
                       [ngClass]="{ 'seat-item' : true , 'seat-unavailable' : true }"
                       *ngIf="seatobj.status == 'unavailable' && seatobj.seatLabel != ''">{{seatobj.seatNo}}</div>
                </div>
              </div>
            </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-3" style="margin-top: 5px;">
            <div class="trip-detail-item">
              <i class="material-icons trip-result-icon">summarize</i>
              <span class="trip-detail-property">{{"totalSelectedSeat"|translate}} : </span>
              <span class="trip-detail-value">{{ cart?.selectedSeats?.length }}</span>
            </div>
            <div class="trip-detail-item">
              <i class="material-icons trip-result-icon">payments</i>
              <span class="trip-detail-property">{{"totalAmount"|translate}}: </span>
              <span class="trip-detail-value">{{cart.totalamount}} ETB</span>
            </div>
            <div class="trip-detail-item">
              <i class="material-icons trip-result-icon">event_seat</i>
              <span class="trip-detail-property">{{"selectedSeat"|translate}}: </span>
              <span class="trip-detail-value" *ngFor="let seatLabel of cart.selectedSeats" class="badge badge-primary">
              {{seatLabel}}</span>
            </div>
            <div class="col-lg-12">
              <button type="button" mat-button (click)="BackToTripList()" color="back-button-color" mat-button
                      class="bootom-action-btn">{{"back"|translate}}
              </button>
              <button [disabled]="cart?.selectedSeats?.length == 0" type="button" mat-button matStepperNext mat-button
                      color="success" class="bootom-action-btn" >{{"bookNow"|translate}}
              </button>
            </div>
        </div>
      </div><!--end of page-->
    </mat-step>
    <form [formGroup]="dynamicForm">
      <mat-step  state="info">
        <ng-template  matStepLabel >
          <span fxShow="false" fxShow.gt-xs="true"> {{"fillPassengerInfoInstruction"|translate}} </span>  
        </ng-template>
        <div class="row">
          <div class="d-none d-lg-block col-md-2 col-lg-4">
              <div class="trip-detail-item">
                <i class="material-icons trip-result-icon">summarize</i>
                <span class="trip-detail-property">{{"totalSelectedSeat"|translate}} : </span>
                <span class="trip-detail-value">{{ cart?.selectedSeats?.length }}</span>
              </div>
              <div class="trip-detail-item">
                <i class="material-icons trip-result-icon">payments</i>
                <span class="trip-detail-property">{{"totalAmount"|translate}}: </span>
                <span class="trip-detail-value">{{cart.totalamount}} ETB</span>
              </div>
              <div class="trip-detail-item">
                <i class="material-icons trip-result-icon">event_seat</i>
                <span class="trip-detail-property">{{"selectedSeat"|translate}}: </span>
                <span class="trip-detail-value" *ngFor="let seatLabel of cart.selectedSeats"
                      class="badge badge-primary">
                  {{seatLabel}}</span>
              </div>
          </div>
          <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 shadow-sm" style="border-radius: 2%; padding: 2%; background-color: hsl(0, 9%, 96%);">

  <div *ngFor="let ticket of t.controls; let i = index" class="list-group list-group-flush">
    <div class="list-group-item">
      <div class="trip-detail-item">
        <i class="material-icons trip-result-icon">person</i>
        <span class="trip-detail-property">{{ 'passenger' | translate }} {{ i + 1 }}</span>
        <span style="float: right;">
          <span class="material-icons trip-result-icon">event_seat</span>
          <span class="trip-detail-property">{{ 'seat' | translate }} {{ this.cart.selectedSeats[i] }}</span>
        </span>
      </div>
      <div [formGroup]="ticket" class="form-row">
  <div class="form-group col-12">
    <div class="input-container">
      <label for="name-{{i}}">{{ 'fullName' | translate }}</label>
      <input
        id="name-{{i}}"
        class="form-input"
        placeholder="{{ 'fullName' | translate }}"
        name="fname"
        formControlName="name"
        required
        maxlength="50"
      />
<div *ngIf="ticket.get('name')?.invalid && (ticket.get('name')?.dirty || ticket.get('name')?.touched)"
         class="error-message">
      <div *ngIf="ticket.get('name')?.errors?.required">
        {{ 'fullNameRequired' | translate }}
      </div>
      <div *ngIf="ticket.get('name')?.errors?.invalidFullName">
        {{ 'fullNameInvalid' | translate }}
      </div>
    </div>
    </div>
  </div>
  <div class="form-group col-12">
    <div class="input-container">
      <label for="phone-{{i}}">{{ 'phoneNumber' | translate }}</label>
      <input
        id="phone-{{i}}"
        class="form-input"
        placeholder="{{ 'phoneNumber' | translate }}"
        name="phone"
        formControlName="phone"
        maxlength="10"
        required
        type="tel"
      />
      <div *ngIf="ticket.get('phone')?.invalid && (ticket.get('phone')?.dirty || ticket.get('phone')?.touched)"
           class="error-message">
        {{ 'phoneNumberRequired' | translate }}
      </div>
    </div>
  </div>
  <div class="form-group col-12">
    <div class="input-container">
      <label for="luggage-{{i}}">{{ 'luggageWeight' | translate }}</label>
      <input
        id="luggage-{{i}}"
        type="number"
        class="form-input"
        placeholder="{{ 'luggageWeight' | translate }}"
        formControlName="laggage"
        min="0"
        max="25"
      />
      <div *ngIf="ticket.get('laggage')?.invalid && (ticket.get('laggage')?.dirty || ticket.get('laggage')?.touched)"
           class="error-message">
        {{ 'luggageWeightInvalid' | translate }}
      </div>
    </div>
  </div>
</div>
    </div>
  </div>
    <div class="card-footer text-center">
                <div>
                  <button mat-button matStepperPrevious color="back-button-color" class="bootom-action-btn">{{"back"|translate}}</button>
                  <button mat-flat-button [disabled]="this.dynamicForm.invalid" color="success" matStepperNext class="bootom-action-btn" style="width:120px">{{"proceedToPay"|translate}}
                  </button>
                </div>
              </div>

          
          </div>
        </div>
      </mat-step>

      <mat-step state="payment">
        <ng-template matStepLabel >
          <span fxShow="false" fxShow.gt-xs="true"> {{"selectPaymentItruction"|translate}} </span> 
        </ng-template>
        <div class="row">
          <div class="d-none d-lg-block col-md-2 col-lg-4">
                <div class="trip-detail-title"> {{routeState.operator| uppercase}} Bus {{"tripDetail"|translate}}</div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">event</i>
                  <span class="trip-detail-property"> {{"tripDate"|translate}} :</span>:
                  <span class="trip-detail-value">{{routeState.tripDate|date:"MMM,dd,yyyy"}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">place</i>
                  <span class="trip-detail-property">{{"route"|translate}}</span>:
                  <span class="trip-detail-value">{{routeState.departureLocation| translate}}
                    - {{routeState.arrivalLocation|translate}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">business</i>
                  <span class="trip-detail-property">{{"departureStation"|translate}}:</span>:
                  <span class="trip-detail-value">{{routeState.departureStation}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">business</i>
                  <span class="trip-detail-property">{{"arrivalStation"|translate}}:</span>:
                  <span class="trip-detail-value"> {{routeState.arrivalStation}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">
                    watch_later
                  </i> <span class="trip-detail-property"> {{"departureTime"|translate}}</span>:
                  <span class="trip-detail-value"> {{routeState.departureTime|date:"hh:mm"}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">call</i>
                  <span class="trip-detail-property">{{"departureSupportPhone"|translate}}</span>:
                  <span class="trip-detail-value">{{routeState.departureLocationPhone}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">event_seat</i>
                  <span class="trip-detail-property"> {{"selectASeat"|translate}}: </span>
                  <span class="trip-detail-value" *ngFor="let seatLabel of cart.selectedSeats"
                        class="badge badge-primary">
                               {{seatLabel}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">payments</i>
                  <span class="trip-detail-property"> {{"totalAmount"|translate}} : </span>
                  <span class="trip-detail-value">{{cart.totalamount}} ETB</span>
                </div>
              </div>
          <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4" >
              <div class="trip-detail-title"> 
                {{routeState.operator | uppercase }} BUS 
                 <p class="trip-detail-property"> 
                   {{routeState.departureLocation |translate}} - {{routeState.arrivalLocation |translate}}
                  </p> 
                <p class="trip-detail-property">{{ routeState.tripDate|date:"MMM dd, Y"}} </p>
                <p class="trip-detail-property">{{"totalSelectedSeat"|translate}} : 
                <span class="trip-detail-value">{{ cart?.selectedSeats?.length }}</span>
              </p>
                 <p class="trip-detail-property">{{"totalAmount"|translate}}: 
                <span class="trip-detail-value">{{cart.totalamount}} ETB</span>
              </p>
              </div>
              <div class="trip-detail-item">
                <span class="trip-detail-property"> {{"selectedSeat"|translate}}: </span>
                <span class="trip-detail-value" *ngFor="let seatLabel of cart.selectedSeats"
                      class="badge badge-primary">
                  {{seatLabel}}</span>
              </div>
        <div class="col-md-12" >
        <p class="trip-detail-title"> {{"paywithmpesa"| translate}} <img src="../../../assets/img/paymentoption/mpesa.png"  alt="pay with M-Pesa"  style="height:60px; margin-bottom: 10px;"/></p>
        <div class="action-buttons card-footer" *ngIf="!loading">
                <button class="reserve-action-btn" mat-button matStepperPrevious mat-flat-button color="back-button-color">{{"back"|translate}}</button>  
               <button  mat-flat-button (click)="selectPayment('Mpesa')" color="success" class="bootom-action-btn" style="width:120px">
                  {{"pay"|translate}}
                  </button>
              </div>
        <div class="spineer-area card-footer" *ngIf="loading">
                 <mat-spinner *ngIf="loading" diameter="30" color="accent" ></mat-spinner>    
                 </div>
                 <br>
                 <br>
              </div>
          </div>
        </div>
      </mat-step>
      </form>
      <mat-step  state="paymentInstruction">
        <ng-template matStepLabel >
           <span fxShow="false" fxShow.gt-xs="true">{{"PaymentInstruction"|translate}}</span>
          </ng-template>
        <div class="row">
          <div class="d-none d-lg-block col-md-2 col-lg-4">
            <div class="reserved-trip-detail">
              <mat-card >
                <div class="trip-detail-title"> {{routeState.operator| uppercase}} Bus</div>
                <div class="trip-detail-title"> {{"tripDetail"|translate}}</div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">event</i>
                  <span class="trip-detail-property">{{"tripDate"|translate}} :</span>:
                  <span class="trip-detail-value">{{ routeState.tripDate|date:"MMM dd,Y"}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">place</i>
                  <span class="trip-detail-property">{{"route"|translate}}</span>:
                  <span class="trip-detail-value">{{ routeState.departureLocation |translate}}
                    To {{routeState.arrivalLocation|translate}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">business</i>
                  <span class="trip-detail-property">{{"departureStation"|translate}}:</span>:
                  <span class="trip-detail-value">{{routeState.departureStation}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">business</i>
                  <span class="trip-detail-property">{{"arrivalStation"|translate}}:</span>:
                  <span class="trip-detail-value"> {{routeState.arrivalStation}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">
                    watch_later
                  </i> <span class="trip-detail-property"> {{"departureTime"|translate}}</span>:
                  <span class="trip-detail-value"> {{routeState.departureTime|date:"hh:mm"}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">call</i>
                  <span class="trip-detail-property">{{"departureSupportPhone"|translate}}</span>:
                  <span class="trip-detail-value">{{routeState.departureLocationPhone}}</span>
                </div>
                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">event_seat</i>
                  <span class="trip-detail-property">{{"selectedSeat"|translate}}: </span>
                  <span class="trip-detail-value" *ngFor="let seatLabel of cart.selectedSeats"
                        class="badge badge-primary">
                  {{seatLabel}}</span>
                </div>

                <div class="trip-detail-item">
                  <i class="material-icons trip-result-icon">payments</i>
                  <span class="trip-detail-property">{{"totalAmount"|translate}}: </span>
                  <span class="trip-detail-value">{{cart.totalamount}} ETB</span>
                </div>
              </mat-card>
            </div>
          </div>

           <div class="col-xs-12 col-sm-12 col-md-5 col-lg-4">
            <mat-card class="center-content" >
              <p class="trip-detail-title">Payment Instruction</p>
              <img [src]="getSelectedImage()" alt="Payment Option" class="selected-payment-img" *ngIf="getSelectedImage()">
              <form #phoneForm="ngForm" (ngSubmit)="proceedToPay()">
                <label for="phone">Please enter your {{this.selectedPayment}} payment phone number</label>
                <input type="text" 
                       id="phone" 
                       [(ngModel)]="phoneNumber" 
                       name="phone" 
                       class="form-control" 
                       required
                       pattern="^[0-9]{10}$"
                       #phoneInput="ngModel">
                <div *ngIf="phoneInput.invalid && phoneInput.touched" class="text-danger">
                   <small *ngIf="phoneInput.errors?.required">Phone number is required.</small>
                   <small *ngIf="phoneInput.errors?.pattern">Enter a valid phone number (10 digits only).</small>
                </div>
                <div class="action-buttons card-footer text-center">
                  <div *ngIf="loading" class="spinner-container">
                  <mat-spinner *ngIf="loading" diameter="30" color="accent" ></mat-spinner>
                 </div>
             <div *ngIf="!loading">
                  <button mat-button matStepperPrevious mat-flat-button color="back-button-color">{{"back"|translate}}</button>  
                  <button type="submit" mat-flat-button [disabled]="phoneForm.invalid" color="success" matStepperNext class="bootom-action-btn" style="width:120px">{{"proceedToPay"|translate}}</button> 
               </div>
                </div>
             </form>
            </mat-card>
          </div> 
        </div>
      </mat-step>
    <ng-template matStepperIcon="seat" >
      <mat-icon>event_seat</mat-icon>
    </ng-template>
    <ng-template matStepperIcon="info">
      <mat-icon>description</mat-icon>
    </ng-template>
    <ng-template matStepperIcon="payment">
      <mat-icon>payments</mat-icon>
    </ng-template>
      <ng-template matStepperIcon="paymentInstruction">
      <mat-icon>description</mat-icon>
    </ng-template>
  </mat-stepper>


